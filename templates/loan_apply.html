{% extends "base.html" %}
{% load static %}

{% block title %}Loan Application{% endblock %}

{% block content %}
<style>
  input:focus, textarea:focus{
  outline:none;
  border-color: rgba(0,65,130,.85) !important;
  box-shadow: 0 0 0 3px rgba(5,69,133,.25) !important;
}
  .back-btn{
  position: relative;
  display: inline-flex;
  align-items: center;
  justify-content: center;

  height: 42px;
  padding: 0 22px 0 28px;   /* left a bit bigger */
  border-radius: 12px;

  background: #13111185;
  color: #ffffffc9;
  font-weight: 800;
  text-decoration: none;

  border: 1px solid rgba(189, 189, 189, 0.164);
  box-shadow:
    0 6px 14px rgba(0,0,0,.18),
    inset 0 1px 0 rgba(255,255,255,.65);
}
/* hover/active */
.back-btn:hover{
  transform: translateY(-1px);
}
.back-btn:active{
  transform: translateY(0px);
  opacity: .92;
}

/* Mobile adjustments */
@media (max-width:520px){
  .top-actions{ padding: 10px 12px 0; }
  .top-actions-line{ margin: 10px 12px 0; }
  .back-btn{ height: 40px; padding: 0 18px 0 24px; font-size: 13px; }
  .back-btn::before{
    left: -13px;
    border-top: 20px solid transparent;
    border-bottom: 20px solid transparent;
    border-right: 13px solid #e7e7e7;
  }
}
  /* Keep your page style — only improve form alignment + ID upload cards + shimmer */
  .wrap{ align-items:flex-start; }

  .page{
    width: min(520px, 94vw);
    margin: 0 auto;
    padding: 14px 14px 24px;
    box-sizing: border-box;
  }

  .section-title{
    margin: 12px 2px 10px;
    color: rgba(255,255,255,.90);
    font-family: 'Ovelion', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    font-weight: 900;
    font-size: 15px;
    letter-spacing: .10em;
    text-transform: uppercase;
  }
  textarea{
    resize:none;
  }

  /* Card (same vibe) + "ភ្លែតៗ" shimmer */
  .cardx{
    position: relative;
    background: rgba(9, 10, 10, 0.856);
    border-radius: 18px;
    padding: 18px;
    backdrop-filter: blur(18px);
    -webkit-backdrop-filter: blur(18px);
    box-shadow: 0 3px 6px rgba(245, 245, 245, 0.808), inset 0 1px 0 rgba(163, 157, 157, 0.918);
    overflow: hidden;
    margin-bottom: 12px;
  }
  

  .grid-2{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }
  @media (max-width: 520px){
    .grid-2{ grid-template-columns: 1fr; }
  }
  /* ===== PC VIEW: make signature big + clear under it ===== */
@media (min-width: 900px){

/* Signature card span 2 columns (be big) */
#sigBox{
  grid-column: 1 / span 2;   /* ឲធំស្មើ 2 ប្រអប់ */
  height: auto;
  padding: 14px;
}

/* Make canvas taller on PC */
#sigBox .sig-canvas{
  height: 260px;             /* អ្នកអាចប្ដូរ 240-320 តាមចិត្ត */
}

/* Put clear button under the signature box (full row) */
.sig-clear-wrap{
  grid-column: 1 / span 2;   /* ឲនៅក្រោម sigBox (ជួរថ្មី) */
  justify-content: flex-end;
  margin-top: 10px;
}
}

  .field{ margin-bottom: 12px; }

  /* Make all textarea shorter */
 /* ONLY make text inputs same height */
input[type="text"],
input[type="number"],
input[type="tel"],
input[type="email"],
input[type="password"],
textarea{
  width:100%;
  height:40px;
  min-height:40px;
  max-height:40px;
  resize:none;
  box-sizing:border-box;
}


  /* ===== ID upload cards (3 boxes) ===== */
  /* 4 in 1 row */
/* ✅ REPLACE your current .id-grid + responsive rules WITH THIS */

/* 3 cards per row on PC + centered */
.id-grid{
  display:grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 18px;
  align-items: stretch;

  /* make the 3 cards area wider + push a bit to the right */
  width: min(900px, 96%);
  margin: 0 0 0 auto;   /* pushes to the right */
}

/* make each card bigger */
.idbox{
  height: 280px;         /* was 240 */
  padding: 14px;
  border-radius: 18px;
}

/* guide image fit nicely */
.id-guide{
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 16px;
  display:block;
}

/* ===== Responsive ===== */
@media (max-width: 1100px){
  .id-grid{ grid-template-columns: repeat(2, 1fr); width: 100%; margin: 0 auto; }
}
@media (max-width: 520px){
  .id-grid{ grid-template-columns: 1fr; }
  .idbox{ height: 240px; }
}
.choose-btn{
  margin-top: 8px;
  display:inline-block;
  padding:8px 10px;
  border-radius: 10px;
  background: rgba(0,0,0,.55);
  border: 1px solid rgba(255,255,255,.18);
  font-weight: 700;
  font-size: 12px;
}

  .idbox{
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,.20);
    background: rgba(0,0,0,.18);
    padding: 10px;
    height: 240px;   /* size like your red box */
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    text-align:center;
    gap: 8px;
    cursor:pointer;
    position:relative;
    overflow:hidden;
  }
  /* ===== Signature draw ===== */
.sig-canvas{
  width: 100%;
  height: 170px;
  border-radius: 14px;
  border: 2px solid rgba(0,65,130,.65);
  background: rgba(0,0,0,.22);
  box-sizing: border-box;
  display: block;
  position: relative;
  z-index: 1;
}
#sigBox{ position: relative; }
#sigBox .sig-canvas{ position:relative; z-index:2; }
#sigBox img#sigPreviewImg{ background: rgba(0,0,0,.22); }

/* Clear button floating (mobile safe) */

#sigBox{
  height: 240px;              /* ទំហំដូច card upload ផ្សេងៗ */
  padding: 12px;
  justify-content: flex-start !important;
  align-items: stretch !important;
  text-align: left !important;
  gap: 10px !important;
}

/* Clear button wrapper under signature */
.sig-clear-wrap{
  width:100%;
  display:flex;
  justify-content:flex-end;
  margin-top:10px;
}

/* Clear button normal */
.sig-clear-wrap .sig-btn{
  padding:10px 18px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.25);
  background: rgba(0,0,0,.45);
  color:#fff;
  font-weight:800;
  cursor:pointer;
}

/* hover = red */
.sig-clear-wrap .sig-btn:hover{
  background: rgba(255,44,44,.85);
}

/* active */
.sig-clear-wrap .sig-btn:active{
  transform: scale(.97);
}

  .idbox small{ opacity:.75; font-weight:700; }
  .idbox strong{ font-weight:900; letter-spacing:.02em; }

  .id-preview{
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    object-fit: cover;
    display:none;
  }
  .idbox.has-img .id-preview{ display:block; }
  .idbox.has-img .id-text{ display:none; }
  .id-text strong{
  font-family: 'Ovelion', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  font-weight: 900;
  letter-spacing: .04em;
}

.id-text small{
  font-family: 'Ovelion', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  opacity: .85;
}

  /* ===== Apply loan summary ===== */
  .summary{
    margin-top: 10px;
    border-top: 1px solid rgba(255,255,255,.14);
    padding-top: 10px;
    display:grid;
    gap: 6px;
    font-size: 14px;
  }
  .summary .row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 10px;
  }
  .summary .k{ opacity:.80; }
  .summary .v{ font-weight: 900; }

  .cta{
    margin-top: 12px;
    width: 100%;
  }
  .field textarea{
  resize: none !important;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  overflow: hidden;
}
.term-grid{
  display:grid;
  grid-template-columns:repeat(6,1fr);
  gap:10px;
  margin-top:10px;
}
@media(max-width:520px){
  .term-grid{ grid-template-columns:repeat(3,1fr); }
}
.term-btn{
  padding:12px 0;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.22);
  background:rgba(255,255,255,.10);
  color:#fff;
  font-weight:800;
  cursor:pointer;
  transition: transform .08s ease, opacity .2s ease;
}
.term-btn:active{ transform:scale(.98); }
.term-btn.active{
  background: linear-gradient(90deg, var(--b1), var(--b2));
  border-color: rgba(0,65,130,.55);
}
/* ===== Loan purposes (clean pills) ===== */
.purpose-grid{
  display:grid;
  grid-template-columns:repeat(2, 1fr);
  gap:10px;
  margin-top:10px;
}
@media(max-width:520px){
  .purpose-grid{ grid-template-columns:1fr; }
}

.purpose-pill{
  display:flex;
  align-items:center;
  justify-content:flex-start;
  gap:10px;

  padding:12px 14px;
  border-radius:999px;

  border:1px solid rgba(255,255,255,.18);
  background:rgba(255,255,255,.08);

  color:#fff;
  font-weight:850;
  font-size:13px;
  letter-spacing:.02em;

  cursor:pointer;
  user-select:none;

  transition: transform .08s ease, background .2s ease, border-color .2s ease;
}
.purpose-pill:active{ transform: scale(.98); }

.purpose-pill input{
  width:18px;
  height:18px;
  margin:0;
  accent-color: #004182;
  flex: 0 0 auto;
}

/* keep label text clean (no wrap ugly) */
.purpose-pill span{
  display:block;
  line-height:1.1;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* when checked → pill turns green */
.purpose-pill:has(input:checked){
  background: linear-gradient(90deg, rgba(0,65,130,.75), rgba(5,69,133,.65));
  border-color: rgba(0,65,130,.55);
  box-shadow: 0 10px 26px rgba(0,0,0,.25);
}

.id-guide{
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 14px;
  display:block;
}

.id-guide{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit:cover;
  border-radius:16px;
  z-index:1;
}

.id-preview{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit:cover;
  border-radius:16px;
  z-index:2;
  display:none;
}

.idbox.has-img .id-preview{
  display:block;
}

.idbox.has-img .id-guide{
  display:none;
}

</style>
<div class="page">
<div class="top-actions-line"></div>

  <div class="cardx">
    <form method="POST" enctype="multipart/form-data">
      {% csrf_token %}

      <div class="grid-2">
        <div class="field">
          <label>Full name</label>
          <input
  type="text"
  name="full_name"
  id="fullName"
  value="{{ loan.full_name|default:'' }}"
  {% if locked %}readonly{% endif %}
  required
  pattern="[A-Za-z ]+"
  title="Letters and spaces only">
        </div>
        <div class="field">
          <label>Age</label>
          <input type="number" name="age" min="18" max="90"
                 value="{{ loan.age|default:'' }}"
                 {% if locked %}readonly{% endif %}
                 required>
        </div>        

        <div class="field">
          <label>Current living</label>
          <textarea
  name="current_living"
  id="currentLiving"
  rows="2"
  required
  {% if locked %}readonly{% endif %}
  pattern="[A-Za-z0-9 ]+"
  title="Letters, numbers and spaces only"
>{{ loan.current_living|default:'' }}</textarea>
        </div>        
        <div class="field">
          <label>Hometown</label>
          <textarea name="hometown" rows="2" required {% if locked %}readonly{% endif %}>{{ loan.hometown|default:'' }}</textarea>
        </div>
        

        <div class="field">
          <label>Income (optional)</label>
          <input
  type="text"
  name="income"
  id="incomeInput"
  inputmode="numeric"
  pattern="[0-9]*"
  value="{{ loan.income|default:'' }}"
  {% if locked %}readonly{% endif %}>
        </div>
        
        <div class="field">
          <label>Monthly expenses</label>
          <input
  type="text"
  name="monthly_expenses"
  id="expensesInput"
  inputmode="numeric"
  pattern="[0-9]*"
  value="{{ loan.monthly_expenses|default:'' }}"
  {% if locked %}readonly{% endif %}
  required>
        </div>
        

        <div class="field">
          <label>Contact of Guarantor</label>
          <input type="tel"
       name="guarantor_contact"
       value="{{ loan.guarantor_contact|default:'' }}"
       inputmode="numeric"
       pattern="[0-9]*"
       placeholder="Phone number"
       oninput="this.value=this.value.replace(/[^0-9]/g,'')"
       {% if locked %}readonly{% endif %}
       required>
        </div>
        
        <div class="field">
          <label>Guarantor's currently living</label>
          <input type="text" name="guarantor_current_living"
                 value="{{ loan.guarantor_current_living|default:'' }}"
                 placeholder="Enter address"
                 {% if locked %}readonly{% endif %}
                 required>
        </div>
        
        <div class="field">
          <label>Identify name</label>
<input
  type="text"
  name="identity_name"
  id="identityName"
  value="{{ loan.identity_name|default:'' }}"
  placeholder="Identify Name"
  {% if locked %}readonly{% endif %}
  required
  pattern="[A-Za-z ]+"
  title="Letters and spaces only">
        </div>
        
        <div class="field">
          <label>Identify numbers</label>
<input
  type="text"
  name="identity_number"
  id="identityNumber"
  value="{{ loan.identity_number|default:'' }}"
  placeholder="Identify Number"
  inputmode="numeric"
  pattern="[0-9]*"
  {% if locked %}readonly{% endif %}
  required>
        </div>
        
        <div class="field" style="grid-column: 1 / -1;">
          <label>Loan purposes (optional)</label>
        
          <div class="purpose-grid">
            <label class="purpose-pill">
              <input type="checkbox" name="loan_purposes" value="Business"
              {% if loan and "Business" in loan.loan_purposes %}checked{% endif %}
              {% if locked %}disabled{% endif %}>
              <span>Business</span>
            </label>
        
            <label class="purpose-pill">
              <input type="checkbox" name="loan_purposes" value="Medical"
              {% if loan and "Medical" in loan.loan_purposes %}checked{% endif %}
              {% if locked %}disabled{% endif %}>
              <span>Medical</span>
            </label>
        
            <label class="purpose-pill">
              <input type="checkbox" name="loan_purposes" value="Education"
              {% if loan and "Education" in loan.loan_purposes %}checked{% endif %}
              {% if locked %}disabled{% endif %}>
              <span>Education</span>
            </label>
        
            <label class="purpose-pill">
              <input type="checkbox" name="loan_purposes" value="Home repair"
              {% if loan and "Home repair" in loan.loan_purposes %}checked{% endif %}
              {% if locked %}disabled{% endif %}>
              <span>Home repair</span>
            </label>
        
            <label class="purpose-pill">
              <input type="checkbox" name="loan_purposes" value="Debt consolidation"
              {% if loan and "Debt consolidation" in loan.loan_purposes %}checked{% endif %}
              {% if locked %}disabled{% endif %}>
              <span>Debt consolidation</span>
            </label>
        
            <label class="purpose-pill">
              <input type="checkbox" name="loan_purposes" value="Emergency"
              {% if loan and "Emergency" in loan.loan_purposes %}checked{% endif %}
              {% if locked %}disabled{% endif %}>
              <span>Emergency</span>
            </label>
        
            <label class="purpose-pill">
              <input type="checkbox" name="loan_purposes" value="Shopping"
              {% if loan and "Shopping" in loan.loan_purposes %}checked{% endif %}
              {% if locked %}disabled{% endif %}>
              <span>Personal Loan</span>
            </label>
        
            <label class="purpose-pill">
              <input type="checkbox" name="loan_purposes" value="Other"
              {% if loan and "Other" in loan.loan_purposes %}checked{% endif %}
              {% if locked %}disabled{% endif %}>
              <span>Other</span>
            </label>
          </div>
        
          <div class="muted" style="margin-top:8px;">Choose one or more (optional)</div>
        </div>
        
      </div>

      <div style="margin-top:12px;">
        <div class="section-title" style="margin:0 0 10px;">ID Required (Upload)</div>

        <div class="id-grid">

          <!-- FRONT -->
          <label class="idbox {% if loan and loan.id_front %}has-img{% endif %}" id="boxFront">
            <img class="id-preview" id="prevFront"
                 {% if loan and loan.id_front %}src="{{ loan.id_front.url }}"{% endif %}
                 alt="ID Front preview">
        
            <img class="id-guide"
                 src="{% static 'img/id_front.webp' %}"
                 alt="ID Front guide">
        
            <input type="file" name="id_front" accept="image/*"
                   {% if not locked %}required{% endif %}
                   {% if locked %}disabled{% endif %}
                   hidden>
          </label>
        
        
          <!-- BACK -->
          <label class="idbox {% if loan and loan.id_back %}has-img{% endif %}" id="boxBack">
            <img class="id-preview" id="prevBack"
                 {% if loan and loan.id_back %}src="{{ loan.id_back.url }}"{% endif %}
                 alt="ID Back preview">
        
            <img class="id-guide"
                 src="{% static 'img/id_back.webp' %}"
                 alt="ID Back guide">
        
            <input type="file" name="id_back" accept="image/*"
                   {% if not locked %}required{% endif %}
                   {% if locked %}disabled{% endif %}
                   hidden>
          </label>
        
        
          <!-- SELFIE -->
          <label class="idbox {% if loan and loan.selfie_with_id %}has-img{% endif %}" id="boxSelfie">
            <img class="id-preview" id="prevSelfie"
                 {% if loan and loan.selfie_with_id %}src="{{ loan.selfie_with_id.url }}"{% endif %}
                 alt="Selfie preview">
        
            <img class="id-guide"
                 src="{% static 'img/id_selfie.webp' %}"
                 alt="Selfie + ID guide">
        
            <input type="file" name="selfie_with_id" accept="image/*"
                   {% if not locked %}required{% endif %}
                   {% if locked %}disabled{% endif %}
                   hidden>
          </label>
        
        </div>
                    
          <!-- SIGNATURE (DRAW) -->
<div class="idbox" id="sigBox">
  <div class="id-text" style="position:relative; z-index:2;">
    <div class="id-ico">✍️</div>
    <strong>Signature</strong>
    <small>Draw your signature</small>
  </div>

  <canvas id="sigCanvas" class="sig-canvas"></canvas>
  {% if loan and loan.signature_image %}
  <img id="sigPreviewImg" src="{{ loan.signature_image.url }}"
       style="width:100%;height:100%;object-fit:contain;border-radius:14px;position:absolute;inset:0;z-index:3;">
{% else %}
  <img id="sigPreviewImg" style="display:none;">
{% endif %}

  <!-- save result here -->
  <input type="hidden" name="signature_data" id="signatureData" value=""
         {% if locked %}disabled{% endif %}>

</div>
<div class="sig-clear-wrap">
  <button type="button"
          class="sig-btn"
          id="sigClear"
          {% if locked %}disabled{% endif %}>
    Clear
  </button>
</div>
        </div>
        

      <hr style="border:0;border-top:1px solid rgba(255,255,255,.16); margin:14px 0;">

      <div class="section-title" style="margin:0 0 10px;">Apply Loan</div>

      <div class="field">
        <label>Loan amount (Min 100,000 • Max 5,000,000)</label>
        <input type="number" name="loan_amount" id="loanAmount" min="100000" max="5000000" required>
      </div>

      <div class="field">
        <label>Loan terms</label>
      
        <input type="hidden" name="loan_terms" id="loanTerms" required>
      
        <div class="term-grid">
          <button type="button" class="term-btn" data-term="6">6</button>
          <button type="button" class="term-btn" data-term="12">12</button>
          <button type="button" class="term-btn" data-term="24">24</button>
          <button type="button" class="term-btn" data-term="36">36</button>
          <button type="button" class="term-btn" data-term="48">48</button>
          <button type="button" class="term-btn" data-term="60">60</button>
        </div>
      
        <div class="muted" id="termHint" style="margin-top:8px;">Choose months</div>
      </div>      

      <div class="summary" aria-live="polite">
        <div class="row"><div class="k">Amount of loan</div><div class="v" id="sumAmount">—</div></div>
        <div class="row"><div class="k">Interest rate</div><div class="v">0.05%</div></div>
        <div class="row"><div class="k">Loan period</div><div class="v" id="sumTerm">—</div></div>
        <div class="row"><div class="k">Monthly repayment</div><div class="v" id="sumMonthly">—</div></div>
      </div>

      {% if locked %}
  <button class="btn btn-primary cta" type="button" disabled style="opacity:.6;">
    Submitted • Waiting for review
  </button>
{% else %}
  <button class="btn btn-primary cta" type="submit" name="action" value="apply_loan">
    Confirm Apply
  </button>
{% endif %}
<!-- TOP ACTIONS -->
<div class="top-actions">
  <a class="back-btn" href="{% url 'profile' %}">
    Back
  </a>
</div>
<div class="top-actions-line"></div>

    </form>
  </div>
</div>

<script>
  // Preview images inside the 3 ID upload cards
  function bindPreview(boxId, inputName, prevId){
    const box = document.getElementById(boxId);
    if(!box) return;
    const input = box.querySelector(`input[name="${inputName}"]`);
    const prev = document.getElementById(prevId);
    if(!input || !prev) return;

    input.addEventListener('change', () => {
      const f = input.files && input.files[0];
      if(!f) return;
      const url = URL.createObjectURL(f);
      prev.src = url;
      box.classList.add('has-img');
    });
  }
  bindPreview('boxFront', 'id_front', 'prevFront');
  bindPreview('boxBack', 'id_back', 'prevBack');
  bindPreview('boxSelfie', 'selfie_with_id', 'prevSelfie');

  // Simple live calc (0.03% monthly) — UI only
  const amountEl = document.getElementById('loanAmount');
  const termEl = document.getElementById('loanTerms');
  const sumAmount = document.getElementById('sumAmount');
  const sumTerm = document.getElementById('sumTerm');
  const sumMonthly = document.getElementById('sumMonthly');

  function fmt(x){
    try{ return new Intl.NumberFormat().format(x); }catch(e){ return String(x); }
  }
  
</script>
<script>
  (function(){
    const hidden = document.getElementById("loanTerms");
    const hint = document.getElementById("termHint");
    const btns = document.querySelectorAll(".term-btn");
  
    btns.forEach(b=>{
      b.addEventListener("click", ()=>{
        btns.forEach(x=>x.classList.remove("active"));
        b.classList.add("active");
        hidden.value = b.dataset.term;
        if(hint) hint.textContent = b.dataset.term + " months";
        if(window.updateSummary) window.updateSummary(); // if your calculator function exists
      });
    });
  })();
  </script>
  <script>
    function updateSummary(){
      const amountEl = document.getElementById("loanAmount");
      const termEl   = document.getElementById("loanTerms");
    
      const outAmount = document.getElementById("sumAmount");
      const outTerm   = document.getElementById("sumTerm");
      const outMonthly= document.getElementById("sumMonthly");
    
      if(!amountEl || !termEl || !outAmount || !outTerm || !outMonthly) return;
    
      const amount = Number(amountEl.value || 0);
      const term   = Number(termEl.value || 0);
    
      // show amount + term
      outAmount.textContent = amount ? amount.toLocaleString() : "—";
      outTerm.textContent   = term ? (term + " months") : "—";
    
      // monthly repayment (simple)
      const rate = 0.0005; // 0.03%  (you can change later)
      if(amount > 0 && term > 0){
        const total = amount + (amount * rate * term);
        const monthly = total / term;
        outMonthly.textContent = Math.round(monthly).toLocaleString();
      }else{
        outMonthly.textContent = "—";
      }
    }
    
    // update when user types amount
    document.addEventListener("input", (e)=>{
      if(e.target && e.target.id === "loanAmount") updateSummary();
    });
    
    // run once on load
    document.addEventListener("DOMContentLoaded", updateSummary);
    </script>
    <script>
      (function(){
        const qs = new URLSearchParams(window.location.search);
        const a = qs.get("amount");
        const t = qs.get("term");
    
        const amountEl = document.getElementById("loanAmount");
        const termHidden = document.getElementById("loanTerms");
        const hint = document.getElementById("termHint");
        const btns = document.querySelectorAll(".term-btn");
    
        if(a && amountEl) amountEl.value = a;
    
        if(t && termHidden){
          termHidden.value = t;
    
          btns.forEach(b=>{
            if(b.dataset.term === String(t)){
              btns.forEach(x=>x.classList.remove("active"));
              b.classList.add("active");
            }
          });
    
          if(hint) hint.textContent = t + " months";
        }
    
        if(window.updateSummary) window.updateSummary();
      })();
    </script>
    <script>
      (function(){
        const full = document.getElementById("fullName");
        if(!full) return;
    
        full.addEventListener("input", function(){
          this.value = this.value.replace(/[^A-Za-z ]+/g, "");
        });
      })();
    </script>
    <script>
      (function(){
        const el = document.getElementById("identityName");
        if(!el) return;
    
        el.addEventListener("input", function(){
          this.value = this.value.replace(/[^A-Za-z ]+/g, "");
        });
      })();
    </script>
    <script>
      (function(){
        const el = document.getElementById("identityNumber");
        if(!el) return;
    
        el.addEventListener("input", function(){
          this.value = this.value.replace(/[^0-9]/g, "");
        });
      })();
    </script>
    <script>
      (function(){
        const living = document.getElementById("currentLiving");
        if(!living) return;
    
        living.addEventListener("input", function(){
          this.value = this.value.replace(/[^A-Za-z0-9 ]+/g, "");
        });
      })();
    </script>
    <script>
      (function(){
        function onlyNumber(el){
          if(!el) return;
          el.addEventListener("input", function(){
            this.value = this.value.replace(/[^0-9]/g, "");
          });
        }
    
        onlyNumber(document.getElementById("incomeInput"));
        onlyNumber(document.getElementById("expensesInput"));
      })();
    </script>
    <script>
      (function(){
        const canvas = document.getElementById("sigCanvas");
        const hidden = document.getElementById("signatureData");
        const clearBtn = document.getElementById("sigClear");
        const form = document.querySelector("form");
      
        if(!canvas || !hidden) return;
      
        const ctx = canvas.getContext("2d");
      
        // resize to match CSS size (important for crisp drawing)
        function resizeCanvas(){
          const rect = canvas.getBoundingClientRect();
          const ratio = window.devicePixelRatio || 1;
      
          canvas.width  = Math.floor(rect.width * ratio);
          canvas.height = Math.floor(rect.height * ratio);
      
          ctx.setTransform(ratio,0,0,ratio,0,0);
      
          ctx.lineWidth = 3;
          ctx.lineCap = "round";
          ctx.lineJoin = "round";
          ctx.strokeStyle = "#3b82f6";
        }
      
        let drawing = false;
        let hasInk = false;
        let lastX = 0, lastY = 0;
      
        function getPos(e){
          const rect = canvas.getBoundingClientRect();
          const touch = e.touches && e.touches[0];
          const clientX = touch ? touch.clientX : e.clientX;
          const clientY = touch ? touch.clientY : e.clientY;
          return { x: clientX - rect.left, y: clientY - rect.top };
        }
      
        function start(e){
          if(canvas.hasAttribute("disabled")) return;
          drawing = true;
          const p = getPos(e);
          lastX = p.x; lastY = p.y;
          e.preventDefault();
        }
      
        function move(e){
          if(!drawing) return;
          const p = getPos(e);
          ctx.beginPath();
          ctx.moveTo(lastX, lastY);
          ctx.lineTo(p.x, p.y);
          ctx.stroke();
          lastX = p.x; lastY = p.y;
          hasInk = true;
          e.preventDefault();
        }
      
        function end(){
          if(!drawing) return;
          drawing = false;
      
          // save base64 to hidden input
          if(hasInk){
            hidden.value = canvas.toDataURL("image/png");
          }
        }
      
        function clear(){
        ctx.clearRect(0,0,canvas.width,canvas.height);
        hidden.value = "";
        hasInk = false;
}

clearBtn && clearBtn.addEventListener("click", clear);
      
        // init
        resizeCanvas();
        window.addEventListener("resize", resizeCanvas);
      
        // mouse
        canvas.addEventListener("mousedown", start);
        canvas.addEventListener("mousemove", move);
        window.addEventListener("mouseup", end);
      
        // touch
        canvas.addEventListener("touchstart", start, {passive:false});
        canvas.addEventListener("touchmove", move, {passive:false});
        canvas.addEventListener("touchend", end);
      
        clearBtn && clearBtn.addEventListener("click", clear);
      
        // REQUIRED: block submit if no signature (only when not locked)
        form && form.addEventListener("submit", (e)=>{
          // if field disabled/locked -> don't validate
          if(hidden.disabled) return;
      
          if(!hidden.value){
            e.preventDefault();
            alert("Please draw your signature first.");
          }
        });
      })();
      (function(){
  const locked = "{{ locked|yesno:'1,0' }}";
  if(locked !== "1") return;

  const canvas = document.getElementById("sigCanvas");
  const img = document.getElementById("sigPreviewImg");
  const clearBtn = document.getElementById("sigClear") || document.querySelector(".sig-btn") || document.querySelector(".sig-btn-float");

  // if we have image preview -> show it and stop drawing
  if(img && img.getAttribute("src")){
    if(canvas) canvas.style.display = "none";
    if(clearBtn) clearBtn.style.display = "none";
  }
})();
      </script>
<script>
  document.querySelectorAll('input[name="loan_purposes"]').forEach(cb => {
    cb.addEventListener('change', function () {
      if (this.checked) {
        document.querySelectorAll('input[name="loan_purposes"]').forEach(other => {
          if (other !== this) other.checked = false;
        });
      }
    });
  });
</script>    
  
{% endblock %}
